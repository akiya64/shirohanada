language: php

php: '5.6'
php: '7.1'

branches:
  only:
    - master

before_install:

    # set SSH settings for push GitHub
    - openssl aes-256-cbc -K $encrypted_15f5b6818add_key -iv $encrypted_15f5b6818add_iv -in .push_github_rsa.enc -out .push_github_rsa -d

before_script:
    #@link https://github.com/Automattic/_s/blob/master/.travis.yml
    - export SNIFFS_DIR=/tmp/sniffs
    - composer install --dev
    - git clone -b master --depth 1 https://github.com/WordPress-Coding-Standards/WordPress-Coding-Standards.git $SNIFFS_DIR
    - vendor/bin/phpcs --config-set installed_paths $SNIFFS_DIR
    # check javascript
    - npm install -g jscs
    # @link http://jshint.com/docs/
    - npm install -g jshint
    # Pull in the WP Core jshint rules.
    - wget https://develop.svn.wordpress.org/trunk/.jshintrc
script:
    - jshint .
    # Search for PHP syntax errors.
    - find . components/ -name "*.php" -maxdepth 1 -exec php -lf {} \;
    - find . components/ -name "*.php" -maxdepth 1 -exec ./vendor/bin/phpcs -p -s -v {} --standard=wordpress \;
    - find . components/ -name "*.css" -maxdepth 1 -exec ./vendor/bin/phpcs -p -s -v {} --standard=wordpress \;

after_success:
    - set -e::;
    #Only Push origin
    - if [[ "false" != "$TRAVIS_PULL_REQUEST" ]]; then echo "Not deploying pull requests." ; exit ; fi
    #only master branch
    - if [[ "master" != "$TRAVIS_BRANCH" ]]; then echo "Not on the 'master' branch." ; exit ; fi
    #fetch temporary origin
    - git config remote.origin.fetch "+refs/heads/*:refs/remotes/origin/*"
    - git fetch
    #make pre-lerease branch and remove for development tools.
    - git checkout -b pre-release remotes/origin/master
    - git rm -rf stylus
    - git rm -fr git-hooks
    - git rm -f .gitignore
    - git rm -f .travis.yml
    - git rm -f README.md
    - git rm -f package.json
    - git rm -f style.css.map
    - git rm -f editor-style.css.map
    - git rm -f fonts/icomoon.zip
    - git rm -f phpcbf-all.sh
    - git rm -f phpmd-all.sh
    - git rm -f composer.*
    - git rm -f .push_github_rsa.enc
    - git commit -m "prepare release"
    #marge release for deployment autumnsky.sakura.ne.jp
    - git checkout -b release remotes/origin/release
    - git merge pre-release -m "Travis build release $TRAVIS_COMMIT"
    - git push git@github.com:akiya64/shirohanada release

env:
  global:
  - GIT_COMMITTER_NAME=travis-ci
  - GIT_COMMITTER_EMAIL=autumnsky64@gmail.com
  - GIT_AUTHOR_NAME=akiya64-in-travis
  - GIT_AUTHOR_EMAIL=autumnsky64@gmail.com
